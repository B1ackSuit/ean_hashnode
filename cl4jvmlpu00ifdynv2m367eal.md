## 从数据库脑裂&双机热备到分布式cap原理

# 双机热备



### 介绍

　　双机热备也可以是双主热备，目的是mysql数据库高可用

　　即能够把主数据库中所有的数据同时写到备份的数据库中，从而实现MySQL数据库的热备份。

------

### 双机热备细节

　　通常说的双机热备是指两台机器都在运行，但并不是两台机器都同时在提供服务。当提供服务的一台出现故障的时候，另外一台会马上自动接管并且提供服务，而且切换的时间非常短。 



　　双机高可用按工作中的切换方式分为：

-   主-备方式（Active-Standby方式）


>主-备方式即指的是一台服务器处于某种业务的激活状态（即Active状态），另一台服务器处于该业务的备用状态（即Standby状态)。

-   双主机方式（Active-Active方式）


>双主机方式即指两种不同业务分别在两台服务器上互为主备状态（即Active-Standby和Standby-Active状态）。

------

### 双机热备方式

　　组成双机热备的方案主要有两种方式：

-   基于共享存储（磁盘阵列）的方式：

>　　共享存储方式主要通过磁盘阵列提供切换后，对数据完整性和连续性的保障。用户数据一般会放在磁盘阵列上，当主机宕机后，备机继续从磁盘阵列上取得原有数据。如下图所示。

>　　这种方式因为使用一台存储设备，往往被业内人士称为磁盘单点故障。但一般来讲存储的安全性较高。所以如果忽略存储设备故障的情况下，这种方式也是业内采用最多的热备方式。

-   基于数据复制的方式：

>　　这种方式主要利用数据的同步方式，保证主备服务器的数据一致性。

------

### 集群方式

　　使用KeepAlived实现高可用的MYSQL_HA集群环境中，MySQL为(Master/Master)主/主同步复制关系，保证MYSQL服务器数据的一致性，用KeepAlived提供虚拟IP，通过KeepAlived来进行故障监控，实现Mysql故障时自动切换。 

　　部署参考：https://blog.csdn.net/wangking717/article/details/84801827

------


# 脑裂

### 什么是脑裂  

　　在HA集群系统中，假设有同一个整体、动作协调的节点A和节点B，节点A和B之间通过heartBeat来检查对方的存活状态,负责协调保证整个集群服务的可用性。正常情况下，如果节点A通过心跳检测不到B的存在的时候，就会接管B的资源，同理节点B检查不到A的存活状态的时候也会接管A的资源。如果出现网络故障，就会导致A和B同时检查不到对方的存活状态认为对方出现异常，这个时候就会导致A接管B的资源，B也会接管A的资源。

　　原来被一个节点访问的资源就会出现被多个节点同时访问的情况，这种情况就是脑裂现象。

------

### 脑裂导致的问题

-   引起数据的不完整性：集群中节点（在脑裂期间）同时访问同一共享资源，而且没有机制去协调控制的话，那么就存在数据的不完整性的可能。
-   服务异常：对外提供的服务出现异常。

------

### 如何解决脑裂问题

-   添加冗余的心跳线,尽量减少“脑裂”发生机会。
-   启用磁盘锁，在发生脑裂的时候可以协调控制对资源的访问。
-   设置仲裁机制。

------

