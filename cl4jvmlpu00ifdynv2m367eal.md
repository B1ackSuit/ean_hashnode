## 从数据库脑裂&双机热备到分布式cap原理

# 双机热备



### 介绍

　　双机热备也可以是双主热备，目的是mysql数据库高可用

　　即能够把主数据库中所有的数据同时写到备份的数据库中，从而实现MySQL数据库的热备份。

------

### 双机热备细节

　　通常说的双机热备是指两台机器都在运行，但并不是两台机器都同时在提供服务。当提供服务的一台出现故障的时候，另外一台会马上自动接管并且提供服务，而且切换的时间非常短。 



　　双机高可用按工作中的切换方式分为：

-   主-备方式（Active-Standby方式）


>主-备方式即指的是一台服务器处于某种业务的激活状态（即Active状态），另一台服务器处于该业务的备用状态（即Standby状态)。

-   双主机方式（Active-Active方式）


>双主机方式即指两种不同业务分别在两台服务器上互为主备状态（即Active-Standby和Standby-Active状态）。

------

### 双机热备方式

　　组成双机热备的方案主要有两种方式：

-   基于共享存储（磁盘阵列）的方式：

>　　共享存储方式主要通过磁盘阵列提供切换后，对数据完整性和连续性的保障。用户数据一般会放在磁盘阵列上，当主机宕机后，备机继续从磁盘阵列上取得原有数据。如下图所示。

>　　这种方式因为使用一台存储设备，往往被业内人士称为磁盘单点故障。但一般来讲存储的安全性较高。所以如果忽略存储设备故障的情况下，这种方式也是业内采用最多的热备方式。

-   基于数据复制的方式：

>　　这种方式主要利用数据的同步方式，保证主备服务器的数据一致性。

------

### 集群方式

　　使用KeepAlived实现高可用的MYSQL_HA集群环境中，MySQL为(Master/Master)主/主同步复制关系，保证MYSQL服务器数据的一致性，用KeepAlived提供虚拟IP，通过KeepAlived来进行故障监控，实现Mysql故障时自动切换。 

　　部署参考：https://blog.csdn.net/wangking717/article/details/84801827

------


# 脑裂

### 什么是脑裂  

　　在HA集群系统中，假设有同一个整体、动作协调的节点A和节点B，节点A和B之间通过heartBeat来检查对方的存活状态,负责协调保证整个集群服务的可用性。正常情况下，如果节点A通过心跳检测不到B的存在的时候，就会接管B的资源，同理节点B检查不到A的存活状态的时候也会接管A的资源。如果出现网络故障，就会导致A和B同时检查不到对方的存活状态认为对方出现异常，这个时候就会导致A接管B的资源，B也会接管A的资源。

　　原来被一个节点访问的资源就会出现被多个节点同时访问的情况，这种情况就是脑裂现象。

------

### 脑裂导致的问题

-   引起数据的不完整性：集群中节点（在脑裂期间）同时访问同一共享资源，而且没有机制去协调控制的话，那么就存在数据的不完整性的可能。
-   服务异常：对外提供的服务出现异常。

------

### 如何解决脑裂问题

-   添加冗余的心跳线,尽量减少“脑裂”发生机会。
-   启用磁盘锁，在发生脑裂的时候可以协调控制对资源的访问。
-   设置仲裁机制。

------

### 参考&转载

http://t.csdn.cn/F3VUX
------

# 两地三中心

## 实例：两地三中心

  文章：郑州暴雨肆虐，商交所数据中心屹立不倒，它做对了什么？


![图片.png](https://cdn.hashnode.com/res/hashnode/image/upload/v1656147890437/WKnLqOenx.png align="left")


  基于这样的架构，又可以衍生出四类模式

-   A/A/S
-   A/Q/S
-   A/S/C
-   A/C/C



#### A/A/S

  这种模式即：Active/Active/StandBy


![图片.png](https://cdn.hashnode.com/res/hashnode/image/upload/v1656147928452/wuYtedxej.png align="left")

  同城的两个数据库之间互相同步，组成高可用，高性能的集群，共同服务应用。异地数据库作为热备，通过实时复制数据，保持三中心数据一致，随时准备替换同城两中心宕机的数据库。

#### A/Q/S

  即 Active/Query/StandBy


![图片.png](https://cdn.hashnode.com/res/hashnode/image/upload/v1656147941701/B2D4yrXCQ.png align="left")

  这是典型的读写分离集群，外加一个异地热备。主库负责承担写入流量，而Query所在节点，就提供大量的只读查询。通过数据同步复制，上海的节点提供热备，随时补上宕机的节点。比起 A/A/S 少了一台承载写入的节点，高并发能力就稍弱。

#### A/S/C

  即 Active/StandBy/Copy


![图片.png](https://cdn.hashnode.com/res/hashnode/image/upload/v1656147949170/z7s-6YyBt.png align="left")

  主机和备机都在同城，异地数据库作为数据硬备。此时，异地的数据就有可能会有一定的丢失。

#### A/C/C

  即 Active/Copy/Copy


![图片.png](https://cdn.hashnode.com/res/hashnode/image/upload/v1656147957623/Q1KXy-BAN.png align="left")

  同城和异地的数据库，都只做数据备份。这种模式下单点故障随时都有可能发生，因此，不提供业务的持续性。仅对次要数据做备份。

>     并不是所有的业务都需要 A/A/S, A/Q/S 那么紧急和重要的防灾措施，随业务不同可采用不同的防灾模式。
>
>     由此可见，只要上海能在烟花台风中不倒，郑州商交所就会稳稳地为期货交易用户执行7*24小时的服务。

### 复制是基础

  数据库的复制，逃不过这几类：

-   Leader-based replication 主从复制
-   MultiLeader-based replication 多主复制
-   Leaderless-based replication 无主复制

  最常用的一类，当属主从复制。


![图片.png](https://cdn.hashnode.com/res/hashnode/image/upload/v1656147966052/uCQ9kvzBd.png align="left")

  数据库在多副本开启的同时，总不能让用户老看昨天的数据。也不能说，用户在北京发条微博，回到上海就看不见了。

  主从复制，要解决两件事：

-   数据复制到多个数据库
-   保持多个副本数据的一致性

  这两件事，带来的好处是：

-   读写分离，提高吞吐
-   切换故障的数据库

#### 复制，提高吞吐

  由上，主从库之间，采用同步复制，时刻保持一致。主库承担写，从库承载读。原本一台库要处理读写，现在分成2台。响应更快，吞吐量（处理的请求）更高。

  但是，这样设计，一定就很完美么？显然不是！全是坑

  首先，只有一个主库时，主库日志写入，更新就算成功。而现在主从架构，还要等从库完成日志写入，主库才能提交日志。

  1-5个步骤里，任何一个失败，本次提交，就算失败。增加一个节点，意味着增加一个失败因子。从库的反应只要稍差那么点时间，主库就会认为从库挂了，从而回滚操作。

  当再增加“从从”库，虽说能服务的用户更多，但等待时间也会线性加倍延长，而且大有提高更新失败的概率。


![图片.png](https://cdn.hashnode.com/res/hashnode/image/upload/v1656147977357/rTomvLwCr.png align="left")

  当每一个从库都采用同步策略时，仅等待日志确认，都可以杀死一大批请求。而当采用异步时，从从库的数据又丧失了与主库的一致性。

  因此，折中的办法就是一台从库采用同步，其他从库则采用异步复制数据。

#### 复制，一个倒下去，另一个站起来

  数据复制的另一个好处，提供高可用。

  当主库下线时，从库接替主库，开始服务用户请求。原下线的主库，此时变成了从库。等再次回来时，新主库把下线时间内的数据更新，补回老主库去。

  这样，虽说服务速度慢下来，始终还能保持系统可用。

  好玩的是，等老主库上线后，因各种原因，比如网络抖动暂时中断，造成新主库与老主库之间通信受阻，两边都认为自己是主库，此时便产生了脑裂(split brain),即新旧主库都接受写入。





------

### 参考&转载

https://mp.weixin.qq.com/s?__biz=MzI2NjMxNzgyMw==&mid=2247489952&idx=1&sn=7cf28dec90b981704b1995d796b6e12e&chksm=ea8ea330ddf92a2682cd7686d888b6e9d5139be943db237c9e2f8e0d57d549f934dd1e1ca8ca&scene=21#wechat_redirect

https://cloud.tencent.com/developer/article/1877592 或者 https://mp.weixin.qq.com/s?__biz=MzI2NjMxNzgyMw==&mid=2247490070&idx=1&sn=9054177844c9c9ce8f9eb0de8fe549a2&chksm=ea8ea086ddf92990349d915544fbb1c670457be8389bd0f53dbf97df712934d3f6fd597d09ab&cur_album_id=1702340871964147714&scene=189#wechat_redirect

------

# CAP原理

## 前提知识：分区容错性

  分区指的是：由于某些异常，导致集群内的机器存在多个互相不连通的区域。

  例如5台机器组成的集群，3台机器在a机架上，另外2台在b机架上。如果两个机架之间的网络断开，那么就会出现一个集群分成了2个分别由3台机器和2台机器组成的分区。

  在出现分区的情况下，集群并不一定是不可用的。因为只是两个分区之间的连接出现异常，如果两个分区对外部系统的连接都是正常的，或者其中一个分区对外部的连接是正常的，那此时集群是有可能对外正常提供服务的。因此，并不一定是不可用的。例如上诉情况下，a机架的对外的网络是正常的，那此时a机架是能够正常响应客户端的查询请求的。

  那么分区容错性指的是什么呢？其实也很简单，主要防止出现脑裂的异常。大数据为了防止出现异常，数据通常保存三份。假设出现分区之后，对数据进行修改，由于出现了分区，无法在集群内进行同步，就有可能出现数据的多个版本，如果只是单分区出现修改，后期还能通过对比恢复一致性，最可怕的是两个分区都对同一份数据进行了不同的修改，这种情况下，即使后期连接恢复，也难以对两个分区的数据进行同步，就出现了数据混乱。

  因此，分区容错性，核心是要防止脑裂的发生。目前通常的做法是，集群数量必须为单数，这样能保证即使发生分区，也最多只会有一个分区获取控制权，其他分区由于无法获得半数以上的投票，从而使得该分区下线停止对外服务。

### 参考&转载

https://www.zhihu.com/question/512915933/answer/2325695371

------

## CAP原理中抛去P的CA

  分布式是以P为基础的，只要是分布式系统，P必然存在，那么可选的就是在CA中寻找平衡。

>       舍弃了P以后的系统，属于单机环境
>
>       此时：数据源只有一个，C(一致性)默认实现
>
>       在单机环境中，如果服务没问题，读写服务可以很快返回，如果服务器挂掉，也可以很容易做到返回响应。

  P要求的网络分区并不在单机环境中实现，所以抛去P后单机环境下的CA处于上述情况

  如果在实现CA的时候去发展网络分区即分布式环境

>         分布式环境下，同一份数据会保存在多台服务器上，大量客户端来访问数据，负载会分布在各个服务器上，两个不同的客户端C1,C2可能访问的是不同的两台服务器S1,S2, 如果S1,S2上当前数据完全一样，C1,C2会拿到同样的数据，满足一致性；
>         而要保证每个时刻S1,S2上的数据完全一样，在每次对数据更新的时候，就必须等待C1,C2都完成了数据更新，该次数据更新操作才能成功返回。

>         当系统在高可用的环境下(A)，当出现分布式的环境后，根据一致性的要求，在C1和C2更新数据的时候，是不能对外服务的，需要完成更新数据都一致后，才能继续服务，这样严重影响系统速度，或者可以理解成这种环境也称不上是分布式环境。



## CAP中的CP和AP


![图片.png](https://cdn.hashnode.com/res/hashnode/image/upload/v1656149828359/CyiI27oAy.png align="left")

  可用性要求所有的读写请求必须在一定的时间得到响应，可以终止，但是不可以一直等待。

  

  当前满足CP，能否也满足A？

>     假设当前分布式系统满足CP，在网络发生分区的情况下，为达到C一致性, 请求只能一直等待，等待网络分区情况解除，系统数据同步完成才能返回，这就无法满足可用性A。

  当前满足AP，能否也满足C？  

>     假设当前分布式系统满足AP, 系统要求在一定的时间内就要返回，在发生网络分区的情况下，为了保证P，即使出现网络分区也要正常提供服务，按时返回数据，可这样不同客户端访问同一份数据会得到不同的结果，这就不能保证数据的(强)一致性C。

>     就目前市场来说，CP更加符合金融类项目，AP更加适合商城类项目。

### 参考&转载

   https://www.zhihu.com/question/285878189

   https://blog.csdn.net/qq_49603742/article/details/107601068



